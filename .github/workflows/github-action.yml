name: Run Make Pull Request Report
on: pull_request

permissions:
  pull-requests: write
  contents: read

jobs:
  first-job:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    name: log test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          fetch-depth: 0
          node-version: '16'

      - name: Install dependencies
        run: npm install

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install gh

      - name: Authenticate with GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token


      - name: Authenticate with GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
      
      - name: Get PR number
        id: get_pr_number
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV

      - name: Fetch PR commits
        run: |
          gh pr view ${{ env.PR_NUMBER }} --json commits > pr_commits.json

      - name: Fetch PR diff
        run: |
          gh pr diff ${{ env.PR_NUMBER }} > pr_diff.txt
        # PRの差分（diff）を `pr_diff.txt` に保存
        
      - name: Fetch file changes in PR
        run: |
          gh api repos/${{ github.repository }}/pulls/${{ env.PR_NUMBER }}/files > pr_files.json

      - name: Get branch name
        run: echo "BRANCH_NAME=${{ github.head_ref }}" >> $GITHUB_ENV

      - name: Run JavaScript to show branch name
        run: node ./actions_job/handle_commits.js

      - name: Run script to create video
        run: node ./actions_job/create_video.js

      - name: Upload video artifact
        uses: actions/upload-artifact@v3
        with:
          name: PRのレビューをゆっくり解説
          path: output.mp4
          
      # Install GitHub CLI
      - name: Install GitHub CLI
        run: |
          sudo apt-get install gh -y

      # Download the video (to prepare it for commenting)
      - name: Download video artifact
        uses: actions/download-artifact@v3
        with:
          name: PRのレビューをゆっくり解説

      # Install GitHub CLI
      - name: Install GitHub CLI
        uses: actions/setup-gh@v3

      # Comment on the PR with the uploaded video link
      - name: Comment on the PR
        run: |
          PR_URL=$(gh pr view ${{ github.event.pull_request.number }} --json url --jq '.url')
          gh pr comment ${{ github.event.pull_request.number }} --body "Here is the review video: [PRのレビューをゆっくり解説](./output.mp4)"

      # Optionally, you can remove the artifact after posting
      - name: Remove uploaded artifact
        run: rm output.mp4

      - name: Comment on PR
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### CI Results
            - Tests: ${{ job.status }}